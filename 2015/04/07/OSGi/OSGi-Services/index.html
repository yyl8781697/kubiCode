
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>（译）OSGi-Services，OSGI-服务 | Kubi Code&#39;Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Kubi Code">
    

    
    <meta name="description" content="本教程介绍了关于服务声明相关的OSGI服务用法，Eclipse Equinox作为OSGI的服务器使用，本教程使用了Eclipse4.3(Kepler)。

1. 准备下面的教程假定你已经熟悉OSGI的运行时以及模块层（原文,译文）相关的描述。
2. OSGI服务2.1. 什么是OSGI服务一个OSGI的服务被定义为一个标准的Java类或者接口，通常一个Java接口被作为服务的接口来使用。一个bu">
<meta property="og:type" content="article">
<meta property="og:title" content="（译）OSGi-Services，OSGI-服务">
<meta property="og:url" content="http://kubicode.me/2015/04/07/OSGi/OSGi-Services/index.html">
<meta property="og:site_name" content="Kubi Code'Blog">
<meta property="og:description" content="本教程介绍了关于服务声明相关的OSGI服务用法，Eclipse Equinox作为OSGI的服务器使用，本教程使用了Eclipse4.3(Kepler)。

1. 准备下面的教程假定你已经熟悉OSGI的运行时以及模块层（原文,译文）相关的描述。
2. OSGI服务2.1. 什么是OSGI服务一个OSGI的服务被定义为一个标准的Java类或者接口，通常一个Java接口被作为服务的接口来使用。一个bu">
<meta property="og:image" content="/img/OSGi_Services/xds10.png.pagespeed.ic.1DBbeaalyZ.png">
<meta property="og:image" content="/img/OSGi_Services/xds20.png.pagespeed.ic.IJyCLdYfU1.png">
<meta property="og:image" content="/img/OSGi_Services/xds30.png.pagespeed.ic.EEf1RNtmnL.png">
<meta property="og:image" content="/img/OSGi_Services/xosgids_startlevel.png.pagespeed.ic.Pg7-ofsXf2.png">
<meta property="og:image" content="/img/OSGi_Services/xosgi_dsservices_activateflag10.png.pagespeed.ic.RkeQvfnzJc.png">
<meta property="og:image" content="/img/OSGi_Services/xds50.gif.pagespeed.ic.DzxMZ781Q5.png">
<meta property="og:image" content="/img/OSGi_Services/xdsconsumer10.gif.pagespeed.ic.rF5gKNe9-g.png">
<meta property="og:image" content="/img/OSGi_Services/xdsconsumer20.gif.pagespeed.ic.KKzYLYoQkg.png">
<meta property="og:image" content="/img/OSGi_Services/xfirstservice10.gif.pagespeed.ic.A7RPff65HQ.png">
<meta property="og:image" content="/img/OSGi_Services/xfirstservice20.gif.pagespeed.ic.974IV6xi0D.png">
<meta property="og:image" content="/img/OSGi_Services/xfirstservice30.gif.pagespeed.ic.kVQ6cg0W8D.png">
<meta property="og:image" content="/img/OSGi_Services/xfirstservice35.gif.pagespeed.ic.2tGlkBTBRY.png">
<meta property="og:image" content="/img/OSGi_Services/xfirstservice40.gif.pagespeed.ic.2UC1QymqyN.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="（译）OSGi-Services，OSGI-服务">
<meta name="twitter:description" content="本教程介绍了关于服务声明相关的OSGI服务用法，Eclipse Equinox作为OSGI的服务器使用，本教程使用了Eclipse4.3(Kepler)。

1. 准备下面的教程假定你已经熟悉OSGI的运行时以及模块层（原文,译文）相关的描述。
2. OSGI服务2.1. 什么是OSGI服务一个OSGI的服务被定义为一个标准的Java类或者接口，通常一个Java接口被作为服务的接口来使用。一个bu">

    
    <link rel="alternative" href="/atom.xml" title="Kubi Code&#39;Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/simpson.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?439f8b724bc712e367d66b5e348997bd";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
      </script>

</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/bart-simpson-09.png" alt="Kubi Code&#39;Blog" title="Kubi Code&#39;Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Kubi Code&#39;Blog">Kubi Code&#39;Blog</a></h1>
				<h2 class="blog-motto">The palest ink is better than the best memory.</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/books">Books</a></li>
					
						<li><a href="/favorites">Favorites</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//bing.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:kubicode.me">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/04/07/OSGi/OSGi-Services/" title="（译）OSGi-Services，OSGI-服务" itemprop="url">（译）OSGi-Services，OSGI-服务</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kubi Code" target="_blank" itemprop="author">Kubi Code</a>
		
  <p class="article-time">
    <time datetime="2015-04-07T13:20:32.000Z" itemprop="datePublished"> 发表于 2015-04-07</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-_准备"><span class="toc-number">1.</span> <span class="toc-text">1. 准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-_OSGI服务"><span class="toc-number">2.</span> <span class="toc-text">2. OSGI服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-_什么是OSGI服务"><span class="toc-number">2.1.</span> <span class="toc-text">2.1. 什么是OSGI服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-_定义服务的最佳实践"><span class="toc-number">2.2.</span> <span class="toc-text">2.2. 定义服务的最佳实践</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-_服务的属性"><span class="toc-number">2.3.</span> <span class="toc-text">2.3. 服务的属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-_OSGI服务的选择"><span class="toc-number">2.4.</span> <span class="toc-text">2.4. OSGI服务的选择</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-_OSGI声明式服务"><span class="toc-number">3.</span> <span class="toc-text">3. OSGI声明式服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-_定义声明式服务"><span class="toc-number">3.1.</span> <span class="toc-text">3.1. 定义声明式服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-_必需的bundles"><span class="toc-number">3.2.</span> <span class="toc-text">3.2. 必需的bundles</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-_一个DS服务的定义"><span class="toc-number">3.3.</span> <span class="toc-text">3.3. 一个DS服务的定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4_自动启动的定义"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 自动启动的定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-_低等级的OSGI服务API"><span class="toc-number">3.5.</span> <span class="toc-text">3.5. 低等级的OSGI服务API</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-_教程：定义一个OSGI服务的声明"><span class="toc-number">4.</span> <span class="toc-text">4. 教程：定义一个OSGI服务的声明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-_教程：通过服务声明来使用服务"><span class="toc-number">5.</span> <span class="toc-text">5. 教程：通过服务声明来使用服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-_OSGI服务低等级的API"><span class="toc-number">6.</span> <span class="toc-text">6. OSGI服务低等级的API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-_使用服务API"><span class="toc-number">6.1.</span> <span class="toc-text">6.1. 使用服务API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-_BundleContext"><span class="toc-number">6.2.</span> <span class="toc-text">6.2. BundleContext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-_注册服务API"><span class="toc-number">6.3.</span> <span class="toc-text">6.3. 注册服务API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-_访问一个服务"><span class="toc-number">6.4.</span> <span class="toc-text">6.4. 访问一个服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-_低等级的API_vs_OSGI服务的声明"><span class="toc-number">6.5.</span> <span class="toc-text">6.5. 低等级的API vs OSGI服务的声明</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-_教程：使用OSGI服务API"><span class="toc-number">7.</span> <span class="toc-text">7. 教程：使用OSGI服务API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1_定义服务的接口"><span class="toc-number">7.1.</span> <span class="toc-text">7.1 定义服务的接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-_创建服务"><span class="toc-number">7.2.</span> <span class="toc-text">7.2. 创建服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-_安装服务"><span class="toc-number">7.3.</span> <span class="toc-text">7.3. 安装服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-_使用你的服务"><span class="toc-number">7.4.</span> <span class="toc-text">7.4. 使用你的服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-_在有服务追踪者时使用服务"><span class="toc-number">7.5.</span> <span class="toc-text">7.5. 在有服务追踪者时使用服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8_Bndtools"><span class="toc-number">8.</span> <span class="toc-text">8 Bndtools</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9_原文链接"><span class="toc-number">9.</span> <span class="toc-text">9 原文链接</span></a></li></ol>
		
		</div>
		
		<blockquote>
<p>本教程介绍了关于服务声明相关的OSGI服务用法，Eclipse Equinox作为OSGI的服务器使用，本教程使用了Eclipse4.3(Kepler)。</p>
</blockquote>
<h2 id="1-_准备">1. 准备</h2><p>下面的教程假定你已经熟悉OSGI的运行时以及模块层（<a href="http://www.vogella.com/tutorials/OSGiServices/article.html" target="_blank" rel="external">原文</a>,<a href="http://kubicode.me/2015/04/04/OSGi-Modularity/" target="_blank" rel="external">译文</a>）相关的描述。</p>
<h2 id="2-_OSGI服务">2. OSGI服务</h2><h3 id="2-1-_什么是OSGI服务">2.1. 什么是OSGI服务</h3><p>一个OSGI的服务被定义为一个标准的Java类或者接口，通常一个Java接口被作为服务的接口来使用。一个<strong>bundle</strong>可以注册或者使用服务，为了达到此功能，OSGI提供了中心的服务注册表。<br><br>一个服务可以被动态的启动和停止，<strong>bundle</strong>在使用服务时必需有这种操控动态行为的能力，<strong>bundle</strong>服务可以注册一个监听器来监听服务的启动和停止。</p>
<h3 id="2-2-_定义服务的最佳实践">2.2. 定义服务的最佳实践</h3><p>定义一个服务最通常的方法就是通过一个含有接口的<strong>bundle</strong>来定义，其他的<strong>bundle</strong>将会提供这个服务的实现，这就可以允许你通过不同的<strong>bundle</strong>来改变服务的实现。</p>
<a id="more"></a>
<h3 id="2-3-_服务的属性">2.3. 服务的属性</h3><p>在<code>BundleContext</code>类里面的<code>registerService()</code>方法你可以通过字典参数来指定任意的属性，你可以通过<code>ServiceReference</code>类中的<code>getProperty()</code>方法去访问一个指定的属性，该类属于<code>org.osgi.framework</code>包。</p>
<h3 id="2-4-_OSGI服务的选择">2.4. OSGI服务的选择</h3><p>如果一些服务都是可用的并且对相同的API都是有效的，那么OSGI运行时将会默认得选择最低的<i>SERVICE_ID</i>作为使用的服务，你也可以通过服务的属性来设置你的<i>SERVICE_RANKING</i>，OSGI默认将会分配一个0的<i>SERVICE_RANKING</i>并且会选择较高<em>RANKING</em>值的服务来运行。（译者：这里我实验了一下，<i>SERVICE_ID</i>不可指定，<i>SERVICE_RANKING</i>可指定，但是默认为<code>null</code>，也就是说你想手动指定运行相同API的服务的话去指定<i>SERVICE_RANKING</i>就好了）<br><br><code>org.osgi.framework</code>包中的<code>Constants</code>类包含了<i>SERVICE_RANKING</i>值的字符串名称常量，这个常量可以用于设置<em>RANKING</em>的值。</p>
<h2 id="3-_OSGI声明式服务">3. OSGI声明式服务</h2><h3 id="3-1-_定义声明式服务">3.1. 定义声明式服务</h3><p>OSGI的声明式服务功能(<em>declarative services</em> 简称：DS)可以让你通过元数据信息(XML)来定义和使用服务。通过DS你可以不使用任何扩展或者实现的类就可以定义服务了，这将允许这些服务在OSGI的运行时被独立的测试。<br><br>OSGI服务组件负责启动服务，通过声明服务或者其他方式来创建服务，这对服务消费者来说是不可见的。（这段不知道咋翻译了-_-，有兴趣去看原文）<br><br>服务组件包含一个XML描述和一个对象实例，服务描述包含服务组件的全部信息，例如组件实例类的名称，服务的接口等。<br><br>服务组件的引用在<em>MANIFEST.MF</em>中通过<em>Service-Component</em>属性来定义，如果OSGI在运行时找到了这样的引用，那么<code>org.eclipse.equinox.ds</code>插件将会创建相应的服务。<br><br>下面样例演示了如何在<em>MANIFEST.MF</em>中定义一个组件的引用：</p>
<pre><code><span class="attribute">Manifest-Version</span>: <span class="string">1.0</span>
<span class="attribute">Bundle-ManifestVersion</span>: <span class="string">2</span>
<span class="attribute">Bundle-Name</span>: <span class="string">Service</span>
<span class="attribute">Bundle-SymbolicName</span>: <span class="string">com.example.e4.rcp.todo.service</span>
<span class="attribute">Bundle-Version</span>: <span class="string">1.0.0.qualifier</span>
<span class="attribute">Bundle-Vendor</span>: <span class="string">EXAMPLE</span>
<span class="attribute">Bundle-RequiredExecutionEnvironment</span>: <span class="string">JavaSE-1.6</span>
<span class="attribute">Bundle-ActivationPolicy</span>: <span class="string">lazy</span>
<span class="attribute">Service-Component</span>: <span class="string">OSGi-INF/service.xml </span>
</code></pre><h3 id="3-2-_必需的bundles">3.2. 必需的bundles</h3><p>为了使用声明服务你需要下面的几个框架<strong>bundles</strong></p>
<ul>
<li>org.eclipse.equinox.util</li>
<li>org.eclipse.equinox.ds</li>
<li>org.eclipse.osgi.services</li>
</ul>
<h3 id="3-3-_一个DS服务的定义">3.3. 一个DS服务的定义</h3><p>通常组件定义通过New → Other… → Plug-in Development → Component Definition在插件项目的<em>OSGI-INF</em>文件中创建，这个定义向导也会将<code>Service-Component</code>属性登记到<em>MANIFEST.MF</em>文件。<br><br>在向导的第一个界面，你可以输入组件定义文件的文件名称，组件名称和实现接口的类。<br><img src="/img/OSGi_Services/xds10.png.pagespeed.ic.1DBbeaalyZ.png" alt=""><br><br>如果你按下完成按钮，服务的编辑界面将会被打开<br><br><img src="/img/OSGi_Services/xds20.png.pagespeed.ic.IJyCLdYfU1.png" alt=""><br><br>在服务的选项卡界面你可以输入服务的提供者或者引用的服务。例如提供一个服务的时候你需要按下<em>Provided Services</em>下面的增加按钮以及选择你希望被实现的接口。<br><img src="/img/OSGi_Services/xds30.png.pagespeed.ic.EEf1RNtmnL.png" alt=""><br><br>最后一步你需要实现提供服务的类（译者：这。。。。-_-，不说了，建议去看原文吧）。<br><br>一个正确的<em>component.xml</em> XML文件将会如下所示：<br><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">scr:component</span> <span class="attribute">xmlns:scr</span>=<span class="value">"http://www.osgi.org/xmlns/scr/v1.1.0"</span> <span class="attribute">name</span>=<span class="value">"ITodoService"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="title">implementation</span> <span class="attribute">class</span>=<span class="value">"com.example.e4.rcp.todo.service.internal.MyTodoServiceImpl"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="title">service</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">provide</span> <span class="attribute">interface</span>=<span class="value">"com.example.e4.rcp.todo.model.ITodoService"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="title">service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">scr:component</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>译者：上面的原图应该是有问题的吧？？？？下面贴上我的图：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">scr:component</span> <span class="attribute">xmlns:scr</span>=<span class="value">"http://www.osgi.org/xmlns/scr/v1.1.0"</span> <span class="attribute">name</span>=<span class="value">"de.vogella.osgi.ds.quoteservice"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="title">implementation</span> <span class="attribute">class</span>=<span class="value">"de.vogella.osgi.ds.quoteservice.QuoteService"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="title">service</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">provide</span> <span class="attribute">interface</span>=<span class="value">"de.vogella.osgi.quote.IQuoteService"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="title">service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">scr:component</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>这意味着有一个名字叫<em>ITodoService</em>的组件，它提供了<code>ITodoService</code>接口对应的服务，这个组件被<code>MyTodoServiceImpl</code>这个类所实现。<br><br>在组件的定义之后你的<em>MANIFEST.MF</em>文件包含一个服务组件的入口</p>
<pre><code>Manifest-<span class="string">Version:</span> <span class="number">1.0</span>
Bundle-<span class="string">ManifestVersion:</span> <span class="number">2</span>
Bundle-<span class="string">Name:</span> Service
Bundle-<span class="string">SymbolicName:</span> com.example.e4.rcp.todo.service
Bundle-<span class="string">Version:</span> <span class="number">1.0</span>.0.qualifier
Bundle-<span class="string">Vendor:</span> EXAMPLE
Bundle-<span class="string">RequiredExecutionEnvironment:</span> JavaSE-<span class="number">1.6</span>
Require-<span class="string">Bundle:</span> com.example.e4.rcp.todo.model;bundle-version=<span class="string">"1.0.0"</span>,
 com.example.e4.rcp.todo.events;bundle-version=<span class="string">"1.0.0"</span>,
 org.eclipse.e4.core.services;bundle-version=<span class="string">"1.0.0"</span>,
 org.eclipse.e4.core.contexts;bundle-version=<span class="string">"1.1.0"</span>,
 javax.inject;bundle-version=<span class="string">"1.0.0"</span>,
 org.eclipse.e4.core.di,
 org.eclipse.e4.ui.model.workbench
Bundle-<span class="string">ActivationPolicy:</span> lazy
Service-<span class="string">Component:</span> OSGI-INF/component.xml 
</code></pre><h3 id="3-4_自动启动的定义">3.4 自动启动的定义</h3><p><code>org.eclipse.core.runtime</code>定义为OSGI的运行时。<br><br><code>org.eclipse.equinox.ds</code>这个<strong>bundle</strong>将会读取组件的元数据，以及基于组件定义文件进行服务的注册。<br><br>因此这两个<strong>bundle</strong>需要在你的服务可用之前进行启动。<br><br>你可以通过在运行配置中设置<em>auto-start</em>为<em>true</em>以及设置他们的启动级别小于<em>default</em>（默认为4）来保证这两个<strong>bundle</strong>先启动。<br><br><img src="/img/OSGi_Services/xosgids_startlevel.png.pagespeed.ic.Pg7-ofsXf2.png" alt=""><br><br>这个需要服务<em>MANIFEST.MF</em>文件中<em>Activate this plug-in when one of its classes is loaded</em>被勾上，通过这个标志可以确保你的服务在<code>org.eclipse.equinox.ds</code>启动之后可用。<br><img src="/img/OSGi_Services/xosgi_dsservices_activateflag10.png.pagespeed.ic.RkeQvfnzJc.png" alt=""><br></p>
<blockquote>
<p>警告：如果你在启动服务时遇到问题，请确保<code>core</code>、<code>ds</code>这两个插件是自动启动的，以及有一个比你服务使用者更低的启动级别，还要确保<em>Activate this plug-in when one of its classes is loaded</em>被勾上。</p>
</blockquote>
<h3 id="3-5-_低等级的OSGI服务API">3.5. 低等级的OSGI服务API</h3><p>OSGI也可以提供一个低等级的API，参见6.1节</p>
<h2 id="4-_教程：定义一个OSGI服务的声明">4. 教程：定义一个OSGI服务的声明</h2><p>下面将会定义一个基于quote样例的DS服务，因此你需要创建一个含有接口定义的的项目“de.vogella.osgi.quote”。<br><br>创建一个插件项目“de.vogella.osgi.quote”，该项目不使用任何模板，并且不创建Activator，在<em>MANIFST.MF</em>文件中导入依赖。<br><br>在你的项目中创建<em>OSGI-INF</em>文件夹，向上文一样创建一个新的组件定义，实现服务接口<code>IQuoteService</code>的类为<code>de.vogella.osgi.ds.quoteservice.QuoteService</code>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> de.vogella.osgi.ds.quoteservice;</span><br><span class="line">	</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.vogella.osgi.quote.IQuoteService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuoteService</span> <span class="keyword">implements</span> <span class="title">IQuoteService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getQuote</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Random random = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="comment">// create a number between 0 and 2</span></span><br><span class="line">    <span class="keyword">int</span> nextInt = random.nextInt(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">switch</span> (nextInt) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"Ds: Tell them I said something"</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"Ds: I feel better already"</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"Ds: Hubba Bubba, Baby!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>打开<em>component.xml</em>以及选择“Source”的选项卡，最终的显示如下所示：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">scr:component</span> <span class="attribute">xmlns:scr</span>=<span class="value">"http://www.osgi.org/xmlns/scr/v1.1.0"</span> <span class="attribute">name</span>=<span class="value">"ITodoService"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="title">implementation</span> <span class="attribute">class</span>=<span class="value">"com.example.e4.rcp.todo.service.internal.MyTodoServiceImpl"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="title">service</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">provide</span> <span class="attribute">interface</span>=<span class="value">"com.example.e4.rcp.todo.model.ITodoService"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="title">service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">scr:component</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>将你的Eclipse/plugin目录下的”org.eclipse.equinox.ds<em>.jar”, “org.eclipse.osgi.services.jar” 和 “org.eclipse.equinox.util</em>.jar” 文件包括到一个文件夹中，如“C:\temp\bundles\plugins”，以及将这些<strong>bundles</strong>通过OSGI运行时进行安装。</p>
<pre><code>install file:c:\temp\bundles\plugins\org<span class="class">.eclipse</span><span class="class">.equinox</span><span class="class">.ds</span><span class="class">.jar</span>
install file:c:\temp\bundles\plugins\org<span class="class">.eclipse</span><span class="class">.equinox</span><span class="class">.util</span><span class="class">.jar</span>
install file:c:\temp\bundles\plugins\org<span class="class">.eclipse</span><span class="class">.osgi</span><span class="class">.services</span><span class="class">.jar</span> 
</code></pre><p>手动的启动这些<strong>bundles</strong>以保证声明引用是可用的。<br><br>导出你自己的<strong>bundle</strong>以及将它安装：</p>
<pre><code>install file:c:\temp\bundles\plugins\de<span class="class">.vogella</span><span class="class">.osgi</span><span class="class">.ds</span><span class="class">.quoteservice</span><span class="class">.jar</span>
</code></pre><p>你可以使用”services”命令来检查你的服务是否已经注册。<br><br><img src="/img/OSGi_Services/xds50.gif.pagespeed.ic.DzxMZ781Q5.png" alt=""><br><br>译者：这里是不是有跳过几步了？那个<code>getQuote()</code>方法还完全还没有调用啊！！！-_-</p>
<h2 id="5-_教程：通过服务声明来使用服务">5. 教程：通过服务声明来使用服务</h2><p>当然你也可以通过DS来定义服务的消费者。<br><br>创建一个名称为“de.vogella.osgi.ds.quoteconsumer”的插件，不使用模板，不要创建Activator，在MANIFEST.MF文件中导入引用包“de.vogella.osgi.quote”。<br><br>创建如下的类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> de.vogella.osgi.ds.quoteconsumer;</span><br><span class="line">	</span><br><span class="line"><span class="keyword">import</span> de.vogella.osgi.quote.IQuoteService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuoteConsumer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> IQuoteService service;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quote</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(service.getQuote());</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Method will be used by DS to set the quote service</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">setQuote</span><span class="params">(IQuoteService service)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"Service was set. Thank you DS!"</span>);</span><br><span class="line">    <span class="keyword">this</span>.service = service;</span><br><span class="line">    <span class="comment">// I know I should not use the service here but just for demonstration</span></span><br><span class="line">    System.out.println(service.getQuote());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Method will be used by DS to unset the quote service</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">unsetQuote</span><span class="params">(IQuoteService service)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"Service was unset. Why did you do this to me?"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.service == service) &#123;</span><br><span class="line">      <span class="keyword">this</span>.service = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>注意：这个类不依赖于OSGI</p>
</blockquote>
<p>创建一个<em>OSGI-INF</em>文件夹以及在这个文件夹中创建新的组件定义:<br><img src="/img/OSGi_Services/xdsconsumer10.gif.pagespeed.ic.rF5gKNe9-g.png" alt=""><br><br>这次将会是使用一个服务，操作“Referenced Services”：<br><img src="/img/OSGi_Services/xdsconsumer20.gif.pagespeed.ic.KKzYLYoQkg.png" alt=""><br><br>选择该实体点击编辑按钮可以通过<code>bind()</code>和<code>unbind()</code>方法来修改对应的绑定。<br><br>操作完之后的<em>component.xml</em>看起来应该是这个样纸的：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">scr:component</span> <span class="attribute">xmlns:scr</span>=<span class="value">"http://www.osgi.org/xmlns/scr/v1.1.0"</span> <span class="attribute">name</span>=<span class="value">"de.vogella.osgi.ds.quoteconsumer"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="title">implementation</span> <span class="attribute">class</span>=<span class="value">"de.vogella.osgi.ds.quoteconsumer.QuoteConsumer"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="title">reference</span> <span class="attribute">bind</span>=<span class="value">"setQuote"</span> <span class="attribute">cardinality</span>=<span class="value">"1..1"</span> <span class="attribute">interface</span>=<span class="value">"de.vogella.osgi.quote.IQuoteService"</span> <span class="attribute">name</span>=<span class="value">"IQuoteService"</span> <span class="attribute">policy</span>=<span class="value">"static"</span> <span class="attribute">unbind</span>=<span class="value">"unsetQuote"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">scr:component</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>对应的<em>MANIFEST.MF</em>应该是这样的：</p>
<pre><code><span class="attribute">Manifest-Version</span>: <span class="string">1.0</span>
<span class="attribute">Bundle-ManifestVersion</span>: <span class="string">2</span>
<span class="attribute">Bundle-Name</span>: <span class="string">Quoteconsumer</span>
<span class="attribute">Bundle-SymbolicName</span>: <span class="string">de.vogella.osgi.ds.quoteconsumer</span>
<span class="attribute">Bundle-Version</span>: <span class="string">1.0.4</span>
<span class="attribute">Bundle-RequiredExecutionEnvironment</span>: <span class="string">JavaSE-1.6</span>
<span class="attribute">Import-Package</span>: <span class="string">de.vogella.osgi.quote</span>
<span class="attribute">Service-Component</span>: <span class="string">OSGI-INF/component.xml </span>
</code></pre><p>导出你的插件以及安装它：</p>
<pre><code>install file:c:\temp\bundles\plugins \de<span class="class">.vogella</span><span class="class">.osgi</span><span class="class">.ds</span><span class="class">.quoteconsumer</span><span class="class">.jar</span>
</code></pre><p>如果你使用<code>start id_of_your_bundle</code>马上进行启动你应该会得到服务已经设置的反馈以及一个quote将会返回给你。</p>
<h2 id="6-_OSGI服务低等级的API">6. OSGI服务低等级的API</h2><h3 id="6-1-_使用服务API">6.1. 使用服务API</h3><p>在OSGI的定义和使用上你应该会喜欢像OSGI服务声明一样更高级别的的服务，因为他们可以简化OSGI服务使用的操作。本章节描述如何让OSGI服务直接工作。<br></p>
<h3 id="6-2-_BundleContext">6.2. BundleContext</h3><p>通过<code>BundleContext</code>类可以访问服务的注册中心。<br><br>一个<strong>bundle</strong>可以定义一个<code>Bundle-Activator</code>（Activator）类，这个必须继承<code>Bundle-Activator</code>接口。如果定义了该类，OSGI将会将<code>BundleContext</code>注入到<code>start()</code>和<code>stop()</code>这两个实现接口的方法中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.osgi.framework.BundleActivator;</span><br><span class="line"><span class="keyword">import</span> org.osgi.framework.BundleContext;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Activator</span> <span class="keyword">implements</span> <span class="title">BundleActivator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(BundleContext context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"Starting bundle"</span>);</span><br><span class="line">    <span class="comment">// do something with the context, e.g. </span></span><br><span class="line">    <span class="comment">// register services</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">(BundleContext context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"Stopping bundle"</span>);</span><br><span class="line">    serviceTracker.close();</span><br><span class="line">    <span class="comment">// do something with the context, e.g. </span></span><br><span class="line">    <span class="comment">// unregister service</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果你没有一个<code>Activator</code>，你可以使用OSGI框架中的<code>FrameworkUtil</code>类来检索得到<code>BundleContext</code>这个类。</p>
<h3 id="6-3-_注册服务API">6.3. 注册服务API</h3><p>一个<strong>bundle</strong>也可以注册它自己为<code>BundleContext</code>的事件<code>ServiceEvents</code>。例如去触发一个新的<strong>bundle</strong>的安装、卸载或者一个服务的注册。（译者：没看懂这段想干嘛？）<br><br>在一个<strong>bundle</strong>中发布一个服务你可以这么做：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Activator</span> <span class="keyword">implements</span> <span class="title">BundleActivator</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(BundleContext context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    context.</span><br><span class="line">      registerService(IMyService.class.getName(), </span><br><span class="line">         <span class="keyword">new</span> ServiceImpl(), <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>一旦一个服务不再使用你必须使用OSGI将这个服务注销，OSGI允许你动态替换服务。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.ungetService(serviceReference);</span><br></pre></td></tr></table></figure></p>
<h3 id="6-4-_访问一个服务">6.4. 访问一个服务</h3><p>一个<strong>bundle</strong>可以通过<code>BundleContext</code>类来获取一个服务，可以用如下来演示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ServiceReference&lt;?&gt; serviceReference = context.</span><br><span class="line">  getServiceReference(IMyService.class.getName());</span><br><span class="line">IMyService service = (IMyService) context.</span><br><span class="line">  getService(serviceReference);</span><br></pre></td></tr></table></figure>
<h3 id="6-5-_低等级的API_vs_OSGI服务的声明">6.5. 低等级的API vs OSGI服务的声明</h3><p>OSGI的服务可以动态的启动和停止。如果你使用OSGI低等级的API就不得不去动态的修改代码，这将会导致你的源代码非常的复杂，如果你不能正确的掌控你的服务消费者对服务保持一个引用，这个服务将不能通过OSGI框架进行移除。<br><br>为了掌控动态的自动化，服务的声明被开发出来了，因为相比较而言服务的声明要比低等级的API更加喜欢。</p>
<h2 id="7-_教程：使用OSGI服务API">7. 教程：使用OSGI服务API</h2><p>在下面我们将定义和消费一个服务，我们的服务将会返回”famous quotes”。<br></p>
<h3 id="7-1_定义服务的接口">7.1 定义服务的接口</h3><p>创建一个插件项目叫做”de.vogella.osgi.quote”，同时创建一个名字叫”de.vogella.osgi.quote”的包，不要使用模板，也不需要创建Activator。之后选择<em>MANIFEST.MF</em>和它的<em>Runtime</em>选项卡，添加”de.vogella.osgi.quote”到导出包。<br><img src="/img/OSGi_Services/xfirstservice10.gif.pagespeed.ic.A7RPff65HQ.png" alt=""><br><br>根据如下的代码创建接口IQuoteService：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> de.vogella.osgi.quote;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IQuoteService</span> </span>&#123;</span><br><span class="line">  <span class="function">String <span class="title">getQuote</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="7-2-_创建服务">7.2. 创建服务</h3><p>我们将创建一个<s>提供</s>实现的接口的<strong>bundle</strong>（译者：删除线为翻译时添加）。<br><br>创建一个名称叫”de.vogella.osgi.quoteservice”的插件项目，不要使用模板。<br><br>选择<em>MANIFEST.MF</em>文件和它的<em>dependecy</em>选项卡，添加”de.vogella.osgi.quote”到插件引用。<br><br><img src="/img/OSGi_Services/xfirstservice20.gif.pagespeed.ic.974IV6xi0D.png" alt=""><br><br>创建如下的一个”QuoteService”类：<br><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> de.vogella.osgi.quoteservice.internal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.vogella.osgi.quote.IQuoteService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuoteService</span> <span class="keyword">implements</span> <span class="title">IQuoteService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getQuote</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Random random = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="comment">// create a number between 0 and 2</span></span><br><span class="line">    <span class="keyword">int</span> nextInt = random.nextInt(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">switch</span> (nextInt) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"Tell them I said something"</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"I feel better already"</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"Hubba Bubba, Baby!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注册服务到它的<code>Activator</code>类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> de.vogella.osgi.quoteservice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.osgi.framework.BundleActivator;</span><br><span class="line"><span class="keyword">import</span> org.osgi.framework.BundleContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.vogella.osgi.quote.IQuoteService;</span><br><span class="line"><span class="keyword">import</span> de.vogella.osgi.quoteservice.internal.QuoteService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Activator</span> <span class="keyword">implements</span> <span class="title">BundleActivator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(BundleContext context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    IQuoteService service = <span class="keyword">new</span> QuoteService();</span><br><span class="line">    <span class="comment">// Third parameter is a hashmap which allows to configure the service</span></span><br><span class="line">    <span class="comment">// Not required in this example</span></span><br><span class="line">    context.registerService(IQuoteService.class.getName(), service,</span><br><span class="line">        <span class="keyword">null</span>);</span><br><span class="line">    System.out.println(<span class="string">"IQuoteService is registered"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">(BundleContext context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="7-3-_安装服务">7.3. 安装服务</h3><p>导出你的<strong>bundles</strong>，在你的服务器上面安装他们，并且启动的你的<strong>bundle</strong>。<br><br><img src="/img/OSGi_Services/xfirstservice30.gif.pagespeed.ic.kVQ6cg0W8D.png" alt=""><br></p>
<blockquote>
<p>什么都没有发生，因为我们还没有提供的消费者。</p>
</blockquote>
<h3 id="7-4-_使用你的服务">7.4. 使用你的服务</h3><p>创建一个新的插件项目”de.vogella.osgi.quoteconsumer”，同样得将”de.vogella.osgi.quote”添加为依赖。<br><br><img src="/img/OSGi_Services/xfirstservice35.gif.pagespeed.ic.2tGlkBTBRY.png" alt=""><br></p>
<blockquote>
<p>请注意，我们添加的是依赖包而不是依赖插件，这种方式可以让我使用不同的实现来替换服务。</p>
</blockquote>
<p>让我们直接使用这个服务。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> de.vogella.osgi.quoteconsumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.osgi.framework.BundleActivator;</span><br><span class="line"><span class="keyword">import</span> org.osgi.framework.BundleContext;</span><br><span class="line"><span class="keyword">import</span> org.osgi.framework.ServiceReference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.vogella.osgi.quote.IQuoteService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Activator</span> <span class="keyword">implements</span> <span class="title">BundleActivator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> BundleContext context;</span><br><span class="line">  <span class="keyword">private</span> IQuoteService service;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(BundleContext context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.context = context;</span><br><span class="line">    <span class="comment">// Register directly with the service</span></span><br><span class="line">    ServiceReference reference = context</span><br><span class="line">        .getServiceReference(IQuoteService.class.getName());</span><br><span class="line">    service = (IQuoteService) context.getService(reference);</span><br><span class="line">    System.out.println(service.getQuote());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">(BundleContext context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    System.out.println(service.getQuote());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>导出这个<strong>bundle</strong>，安装它，然后启动它，最后停止它，一切工作正常。但是如果你停止<strong>bundle</strong>的服务你将会得到一个错误。<br><br><img src="/img/OSGi_Services/xfirstservice40.gif.pagespeed.ic.2UC1QymqyN.png" alt=""><br><br>原因是OSGI是一个非常冬天的环境，服务可能在任何时刻都在注册和注销，下一章节将会使用服务追踪者来提升这个效果。</p>
<h3 id="7-5-_在有服务追踪者时使用服务">7.5. 在有服务追踪者时使用服务</h3><p>在你的<strong>bundle</strong>中添加对”org.osgi.util.tracker”的依赖，使用下面的代码来定义MyQuoteServiceTrackerCustomizer：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> de.vogella.osgi.quoteconsumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.osgi.framework.BundleContext;</span><br><span class="line"><span class="keyword">import</span> org.osgi.framework.ServiceReference;</span><br><span class="line"><span class="keyword">import</span> org.osgi.util.tracker.ServiceTrackerCustomizer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.vogella.osgi.quote.IQuoteService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyQuoteServiceTrackerCustomizer</span> <span class="keyword">implements</span></span><br><span class="line">    <span class="title">ServiceTrackerCustomizer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> BundleContext context;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MyQuoteServiceTrackerCustomizer</span><span class="params">(BundleContext context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.context = context;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> MyThread thread;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">addingService</span><span class="params">(ServiceReference reference)</span> </span>&#123;</span><br><span class="line">    IQuoteService service = (IQuoteService) context.getService(reference);</span><br><span class="line">    thread = <span class="keyword">new</span> MyThread(service);</span><br><span class="line">    thread.start();</span><br><span class="line">    <span class="keyword">return</span> service;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">modifiedService</span><span class="params">(ServiceReference reference, Object service)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// removedService(reference, service);</span></span><br><span class="line">    <span class="comment">// addingService(reference);</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removedService</span><span class="params">(ServiceReference reference, Object service)</span> </span>&#123;</span><br><span class="line">    context.ungetService(reference);</span><br><span class="line">    System.out.println(<span class="string">"How sad. Service for quote is gone"</span>);</span><br><span class="line">    thread.stopThread();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> active = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IQuoteService service;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(IQuoteService service)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.service = service;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">while</span> (active) &#123;</span><br><span class="line">        System.out.println(service.getQuote());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          System.out.println(<span class="string">"Thread interrupted "</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      active = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>你还需要在你的Activator中注册一个服务:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> de.vogella.osgi.quoteconsumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.osgi.framework.BundleActivator;</span><br><span class="line"><span class="keyword">import</span> org.osgi.framework.BundleContext;</span><br><span class="line"><span class="keyword">import</span> org.osgi.util.tracker.ServiceTracker;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.vogella.osgi.quote.IQuoteService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Activator</span> <span class="keyword">implements</span> <span class="title">BundleActivator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> ServiceTracker serviceTracker;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(BundleContext context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"Starting quoteconsumer bundles"</span>);</span><br><span class="line">    <span class="comment">// Register directly with the service</span></span><br><span class="line">    MyQuoteServiceTrackerCustomizer customer = <span class="keyword">new</span> MyQuoteServiceTrackerCustomizer(context);</span><br><span class="line">    serviceTracker = <span class="keyword">new</span> ServiceTracker(context, IQuoteService.class</span><br><span class="line">        .getName(), customer);</span><br><span class="line">    serviceTracker.open();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">(BundleContext context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"Stopping quoteconsumer bundles"</span>);</span><br><span class="line">    serviceTracker.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再次导出你的<strong>bundle</strong>，启动OSGI控制台，使用更新命令或者安装命令得到你的新版本并且启动它，一旦你启动你的服务<strong>bundle</strong>，追踪者将会被调用，消费者<strong>bundle</strong>将会启动然后输出消息到控制台，停止服务之后可以验证消费者将不再使用服务。</p>
<h2 id="8_Bndtools">8 Bndtools</h2><p>Eclipse使用PDE工具来管理<strong>bundles</strong>，另外你可以使用托管在<a href="http://bndtools.org/" target="_blank" rel="external">http://bndtools.org/</a>上的Bndtools。</p>
<h2 id="9_原文链接">9 原文链接</h2><p>参考的原文为<a href="http://www.vogella.com/tutorials/OSGiServices/article.html" target="_blank" rel="external">OSGi Services - Tutorial</a></p>
<blockquote>
<p>其实这里在原文中本来是版权协议的，我当然是没必要翻译了-_-!，</p>
</blockquote>
<hr>
<blockquote>
<p>本作品采用<a href="http://creativecommons.org/licenses/by-nc-sa/2.5/cn/" target="_blank">[知识共享署名-非商业性使用-相同方式共享 2.5]</a>中国大陆许可协议进行许可，我的博客欢迎复制共享，但在同时，希望保留我的署名权<a href="http://kubicode.me/" target="_blank" rel="external">kubiCode</a>，并且，不得用于商业用途。如您有任何疑问或者授权方面的协商，请给<a href="http://kubicode.me/about/" target="_blank" rel="external">我留言</a>。</p>
</blockquote>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/OSGi/">OSGi</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/OSGi/">OSGi</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://kubicode.me/2015/04/07/OSGi/OSGi-Services/" data-title="（译）OSGi-Services，OSGI-服务 | Kubi Code&#39;Blog" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/04/14/Java Source/Java-HashSet/" title="Java 源码学习之java.util.HashSet">
  <strong>上一篇：</strong><br/>
  <span>
  Java 源码学习之java.util.HashSet</span>
</a>
</div>


<div class="next">
<a href="/2015/04/04/OSGi/OSGi-Modularity/"  title="（译）OSGi-Modularity，OSGi-模块化">
 <strong>下一篇：</strong><br/> 
 <span>（译）OSGi-Modularity，OSGi-模块化
</span>
</a>
</div>

</nav>

	

<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-_准备"><span class="toc-number">1.</span> <span class="toc-text">1. 准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-_OSGI服务"><span class="toc-number">2.</span> <span class="toc-text">2. OSGI服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-_什么是OSGI服务"><span class="toc-number">2.1.</span> <span class="toc-text">2.1. 什么是OSGI服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-_定义服务的最佳实践"><span class="toc-number">2.2.</span> <span class="toc-text">2.2. 定义服务的最佳实践</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-_服务的属性"><span class="toc-number">2.3.</span> <span class="toc-text">2.3. 服务的属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-_OSGI服务的选择"><span class="toc-number">2.4.</span> <span class="toc-text">2.4. OSGI服务的选择</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-_OSGI声明式服务"><span class="toc-number">3.</span> <span class="toc-text">3. OSGI声明式服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-_定义声明式服务"><span class="toc-number">3.1.</span> <span class="toc-text">3.1. 定义声明式服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-_必需的bundles"><span class="toc-number">3.2.</span> <span class="toc-text">3.2. 必需的bundles</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-_一个DS服务的定义"><span class="toc-number">3.3.</span> <span class="toc-text">3.3. 一个DS服务的定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4_自动启动的定义"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 自动启动的定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-_低等级的OSGI服务API"><span class="toc-number">3.5.</span> <span class="toc-text">3.5. 低等级的OSGI服务API</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-_教程：定义一个OSGI服务的声明"><span class="toc-number">4.</span> <span class="toc-text">4. 教程：定义一个OSGI服务的声明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-_教程：通过服务声明来使用服务"><span class="toc-number">5.</span> <span class="toc-text">5. 教程：通过服务声明来使用服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-_OSGI服务低等级的API"><span class="toc-number">6.</span> <span class="toc-text">6. OSGI服务低等级的API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-_使用服务API"><span class="toc-number">6.1.</span> <span class="toc-text">6.1. 使用服务API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-_BundleContext"><span class="toc-number">6.2.</span> <span class="toc-text">6.2. BundleContext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-_注册服务API"><span class="toc-number">6.3.</span> <span class="toc-text">6.3. 注册服务API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-_访问一个服务"><span class="toc-number">6.4.</span> <span class="toc-text">6.4. 访问一个服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-_低等级的API_vs_OSGI服务的声明"><span class="toc-number">6.5.</span> <span class="toc-text">6.5. 低等级的API vs OSGI服务的声明</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-_教程：使用OSGI服务API"><span class="toc-number">7.</span> <span class="toc-text">7. 教程：使用OSGI服务API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1_定义服务的接口"><span class="toc-number">7.1.</span> <span class="toc-text">7.1 定义服务的接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-_创建服务"><span class="toc-number">7.2.</span> <span class="toc-text">7.2. 创建服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-_安装服务"><span class="toc-number">7.3.</span> <span class="toc-text">7.3. 安装服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-_使用你的服务"><span class="toc-number">7.4.</span> <span class="toc-text">7.4. 使用你的服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-_在有服务追踪者时使用服务"><span class="toc-number">7.5.</span> <span class="toc-text">7.5. 在有服务追踪者时使用服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8_Bndtools"><span class="toc-number">8.</span> <span class="toc-text">8 Bndtools</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9_原文链接"><span class="toc-number">9.</span> <span class="toc-text">9 原文链接</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Akka/" title="Akka">Akka<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>39</sup></a></li>
		  
		
		  
			<li><a href="/categories/Data-Struct/" title="Data Struct">Data Struct<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Deep-Learning/" title="Deep Learning">Deep Learning<sup>12</sup></a></li>
		  
		
		  
			<li><a href="/categories/Dotnet/" title="Dotnet">Dotnet<sup>7</sup></a></li>
		  
		
		  
			<li><a href="/categories/Effective-Java/" title="Effective Java">Effective Java<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/Food/" title="Food">Food<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hadoop/" title="Hadoop">Hadoop<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hexo/" title="Hexo">Hexo<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java-Base/" title="Java Base">Java Base<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Java-Source/" title="Java Source">Java Source<sup>7</sup></a></li>
		  
		
		  
			<li><a href="/categories/Javascript/" title="Javascript">Javascript<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/LeetCode/" title="LeetCode">LeetCode<sup>25</sup></a></li>
		  
		
		  
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/Mac/" title="Mac">Mac<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Machine-Learning/" title="Machine Learning">Machine Learning<sup>29</sup></a></li>
		  
		
		  
			<li><a href="/categories/OSGi/" title="OSGi">OSGi<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/PHP/" title="PHP">PHP<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Python/" title="Python">Python<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Scala/" title="Scala">Scala<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Search-Engine/" title="Search Engine">Search Engine<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/Spark/" title="Spark">Spark<sup>5</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Machine-Learning/" title="Machine Learning">Machine Learning<sup>45</sup></a></li>
			
		
			
				<li><a href="/tags/Algorithm/" title="Algorithm">Algorithm<sup>42</sup></a></li>
			
		
			
				<li><a href="/tags/LeetCode/" title="LeetCode">LeetCode<sup>25</sup></a></li>
			
		
			
				<li><a href="/tags/Java/" title="Java">Java<sup>21</sup></a></li>
			
		
			
				<li><a href="/tags/Search-Engine/" title="Search Engine">Search Engine<sup>13</sup></a></li>
			
		
			
				<li><a href="/tags/Deep-Learning/" title="Deep Learning">Deep Learning<sup>12</sup></a></li>
			
		
			
				<li><a href="/tags/CSharp/" title="CSharp">CSharp<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/Food/" title="Food">Food<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Hadoop/" title="Hadoop">Hadoop<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Spark/" title="Spark">Spark<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Vim/" title="Vim">Vim<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Scala/" title="Scala">Scala<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Asp-Net/" title="Asp.Net">Asp.Net<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo/" title="Hexo">Hexo<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/pager/" title="pager">pager<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/OSGi/" title="OSGi">OSGi<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Data-Struct/" title="Data Struct">Data Struct<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Mac/" title="Mac">Mac<sup>2</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="http://quanru.github.io/" target="_blank" title="quanru&#39;s Blog">quanru&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="http://qcl6355.github.io/" target="_blank" title="Sheng Li&#39;s Blog">Sheng Li&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="http://youngyoungkang.github.io/" target="_blank" title="Young Young Kang&#39;s Blog">Young Young Kang&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="http://nlpnoob.com/" target="_blank" title="DataKingdom&#39;s Blog">DataKingdom&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="http://jinfagang.gitlab.io" target="_blank" title="jinfagang&#39;s Blog">jinfagang&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.yifanguo.top/" target="_blank" title="yifanguo&#39;s Blog">yifanguo&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2020 
		
		<a href="/about" target="_blank" title="Kubi Code">Kubi Code</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>




<script type="text/javascript">

var disqus_shortname = 'kubiCode';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['\$','\$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    },
    displayAlign: "center"
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="/js/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>

